---
import { getCollection } from 'astro:content';

const blogPosts = await getCollection('blog', ({ data }) => data.draft !== true);
const mediaEntries = await getCollection('media');

type ContentItem = {
  title: string;
  date: Date;
  type: 'blog' | 'media';
  summary: string;
  slug: string;
  url: string;
  metadata: {
    badge?: string;
    icon?: string;
    venue?: string;
    category?: string;
    tags?: string[];
  };
};

const allContent: ContentItem[] = [
  ...blogPosts.map(post => ({
    title: post.data.title,
    date: post.data.updated || post.data.date,
    type: 'blog' as const,
    summary: post.data.summary,
    slug: post.slug,
    url: `/blog/${post.slug}`,
    metadata: {
      badge: 'Article',
      icon: 'document',
      category: post.data.category,
      tags: post.data.tags.slice(0, 2),
    },
  })),
  ...mediaEntries.map(entry => ({
    title: entry.data.title,
    date: entry.data.date,
    type: 'media' as const,
    summary: entry.data.summary || `${entry.data.type} at ${entry.data.venue}`,
    slug: entry.slug,
    url: `/media/${entry.slug}`,
    metadata: {
      badge: entry.data.type === 'talk' ? 'Conference Talk' :
             entry.data.type === 'podcast' ? 'Podcast' :
             entry.data.type === 'interview' ? 'Interview' :
             entry.data.type === 'press' ? 'Press' :
             'Award',
      icon: entry.data.type,
      venue: entry.data.venue,
    },
  })),
];

const sortedContent = allContent
  .sort((a, b) => b.date.getTime() - a.date.getTime())
  .slice(0, 3);

const formatDate = (date: Date) => {
  return new Intl.DateTimeFormat('en-US', {
    year: 'numeric',
    month: 'short',
    day: 'numeric'
  }).format(date);
};

const getTypeColor = (type: string) => {
  if (type === 'blog') return '#f97316';
  if (type === 'talk' || type === 'podcast' || type === 'interview') return '#3b82f6';
  if (type === 'award') return '#ef4444';
  if (type === 'press') return '#10b981';
  return '#8b5cf6';
};

const getIcon = (iconType: string) => {
  const icons: Record<string, string> = {
    document: `<path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>`,
    talk: `<path d="M15 10.5a3 3 0 11-6 0 3 3 0 016 0z"/><path d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1115 0z"/>`,
    podcast: `<path d="M9.348 14.651a3.75 3.75 0 010-5.303m5.304 0a3.75 3.75 0 010 5.303m-7.425 2.122a6.75 6.75 0 010-9.546m9.546 0a6.75 6.75 0 010 9.546M5.106 18.894c-3.808-3.808-3.808-9.98 0-13.789m13.788 0c3.808 3.808 3.808 9.981 0 13.79M12 12h.008v.007H12V12zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z"/>`,
    interview: `<path d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/>`,
    press: `<path d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"/>`,
    award: `<path d="M16.5 18.75h-9m9 0a3 3 0 013 3h-15a3 3 0 013-3m9 0v-3.375c0-.621-.503-1.125-1.125-1.125h-.871M7.5 18.75v-3.375c0-.621.504-1.125 1.125-1.125h.872m5.007 0H9.497m5.007 0a7.454 7.454 0 01-.982-3.172M9.497 14.25a7.454 7.454 0 00.981-3.172M5.25 4.236c-.982.143-1.954.317-2.916.52A6.003 6.003 0 007.73 9.728M5.25 4.236V4.5c0 2.108.966 3.99 2.48 5.228M5.25 4.236V2.721C7.456 2.41 9.71 2.25 12 2.25c2.291 0 4.545.16 6.75.47v1.516M7.73 9.728a6.726 6.726 0 002.748 1.35m8.272-6.842V4.5c0 2.108-.966 3.99-2.48 5.228m2.48-5.492a46.32 46.32 0 012.916.52 6.003 6.003 0 01-5.395 4.972m0 0a6.726 6.726 0 01-2.749 1.35m0 0a6.772 6.772 0 01-3.044 0"/>`,
    academic: `<path d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25"/>`,
  };
  return icons[iconType] || icons.document;
};
---

<section class="thought-leadership">
  <div class="container">
    <div class="section-header">
      <h2 id="insights" class="section-title anchor-heading">
        Latest Insights
        <a href="#insights" class="anchor-link" aria-label="Link to Latest Insights section">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
            <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
          </svg>
        </a>
      </h2>
      <p class="section-subtitle">Recent articles, talks, and contributions</p>
    </div>

    <div class="content-grid">
      {sortedContent.map(item => (
        <article class="content-card" data-type={item.type}>
          <div class="card-header">
            <div class="card-icon" style={`background-color: ${getTypeColor(item.metadata.icon || item.type)}15`}>
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style={`color: ${getTypeColor(item.metadata.icon || item.type)}`}>
                <Fragment set:html={getIcon(item.metadata.icon || 'document')} />
              </svg>
            </div>
            <div class="card-meta">
              <span class="content-type">{item.metadata.badge}</span>
              <time datetime={item.date.toISOString()} class="content-date">
                {formatDate(item.date)}
              </time>
            </div>
          </div>

          <h3 class="card-title">
            <a href={item.url}>{item.title}</a>
          </h3>

          {item.metadata.venue && (
            <p class="card-venue">{item.metadata.venue}</p>
          )}

          <p class="card-summary">{item.summary}</p>

          {item.metadata.tags && item.metadata.tags.length > 0 && (
            <div class="card-tags">
              {item.metadata.tags.map(tag => (
                <span class="tag">{tag}</span>
              ))}
            </div>
          )}

          <a href={item.url} class="read-more">
            {item.type === 'blog' ? 'Read Article' : 'Learn More'}
            <svg viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd"/>
            </svg>
          </a>
        </article>
      ))}
    </div>

    <div class="section-footer">
      <a href="/blog" class="view-all-btn">
        View All Insights
        <svg viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd"/>
        </svg>
      </a>
    </div>
  </div>
</section>

<style>
  .thought-leadership {
    padding: var(--space-16) 0;
    background-color: var(--color-neutral-50);
    position: relative;
  }

  .container {
    max-width: var(--container-max);
    margin: 0 auto;
    padding: 0 var(--space-4);
  }

  .section-header {
    text-align: center;
    margin-bottom: var(--space-10);
  }

  .section-title {
    font-size: var(--text-4xl);
    font-weight: var(--font-bold);
    color: var(--color-text-primary);
    margin-bottom: var(--space-2);
  }

  .anchor-heading {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
  }

  .anchor-link {
    display: inline-flex;
    align-items: center;
    opacity: 0;
    transition: opacity var(--transition-fast);
    text-decoration: none;
    color: var(--color-primary);
  }

  .anchor-link svg {
    width: 24px;
    height: 24px;
  }

  .anchor-heading:hover .anchor-link {
    opacity: 1;
  }

  .anchor-link:focus {
    opacity: 1;
    outline: 2px solid var(--color-primary);
    outline-offset: 2px;
    border-radius: var(--radius-sm);
  }

  .section-subtitle {
    font-size: var(--text-lg);
    color: var(--color-text-secondary);
  }

  .content-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: var(--space-6);
    margin-bottom: var(--space-8);
  }

  .content-card {
    background: white;
    border: 1px solid var(--color-neutral-200);
    border-radius: var(--radius-xl);
    padding: var(--space-6);
    display: flex;
    flex-direction: column;
    transition: all var(--transition-base);
    height: 100%;
  }

  .content-card:hover {
    box-shadow: var(--shadow-lg);
    transform: translateY(-4px);
  }

  .card-header {
    display: flex;
    align-items: flex-start;
    gap: var(--space-3);
    margin-bottom: var(--space-4);
  }

  .card-icon {
    flex-shrink: 0;
    width: 40px;
    height: 40px;
    border-radius: var(--radius-lg);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .card-icon svg {
    width: 22px;
    height: 22px;
  }

  .card-meta {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
  }

  .content-type {
    font-size: var(--text-xs);
    font-weight: var(--font-bold);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--color-primary);
  }

  .content-date {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
  }

  .card-title {
    font-size: var(--text-xl);
    font-weight: var(--font-bold);
    line-height: var(--leading-tight);
    margin-bottom: var(--space-3);
  }

  .card-title a {
    color: var(--color-text-primary);
    text-decoration: none;
    transition: color var(--transition-fast);
  }

  .card-title a:hover {
    color: var(--color-primary);
  }

  .card-venue {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    margin-bottom: var(--space-3);
    font-weight: var(--font-medium);
  }

  .card-summary {
    color: var(--color-text-secondary);
    line-height: var(--leading-relaxed);
    margin-bottom: var(--space-4);
    flex: 1;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .card-tags {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
    margin-bottom: var(--space-4);
  }

  .tag {
    padding: var(--space-1) var(--space-2);
    background-color: rgba(249, 115, 22, 0.1);
    color: var(--color-primary);
    border-radius: var(--radius-md);
    font-size: var(--text-xs);
    font-weight: var(--font-medium);
  }

  .read-more {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    color: var(--color-primary);
    font-weight: var(--font-medium);
    text-decoration: none;
    transition: gap var(--transition-fast);
    margin-top: auto;
    font-size: var(--text-sm);
  }

  .read-more:hover {
    gap: var(--space-3);
  }

  .read-more svg {
    width: 16px;
    height: 16px;
    transition: transform var(--transition-fast);
  }

  .read-more:hover svg {
    transform: translateX(4px);
  }

  .section-footer {
    text-align: center;
    padding-top: var(--space-4);
  }

  .view-all-btn {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-3) var(--space-5);
    background: white;
    color: var(--color-primary);
    border: 2px solid var(--color-primary);
    border-radius: var(--radius-lg);
    font-weight: var(--font-medium);
    text-decoration: none;
    transition: all var(--transition-base);
  }

  .view-all-btn:hover {
    background: var(--color-primary);
    color: white;
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
  }

  .view-all-btn svg {
    width: 18px;
    height: 18px;
    transition: transform var(--transition-fast);
  }

  .view-all-btn:hover svg {
    transform: translateX(4px);
  }

  @media (max-width: 968px) {
    .content-grid {
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: var(--space-5);
    }
  }

  @media (max-width: 768px) {
    .thought-leadership {
      padding: var(--space-12) 0;
    }

    .section-title {
      font-size: var(--text-3xl);
    }

    .section-subtitle {
      font-size: var(--text-base);
    }
  }

  @media (max-width: 640px) {
    .thought-leadership {
      padding: var(--space-10) 0;
    }

    .content-grid {
      grid-template-columns: 1fr;
      gap: var(--space-4);
    }

    .content-card {
      padding: var(--space-4);
    }

    .card-title {
      font-size: var(--text-lg);
    }

    .section-title {
      font-size: var(--text-2xl);
    }
  }

  @media (max-width: 480px) {
    .thought-leadership {
      padding: var(--space-8) 0;
    }

    .content-card {
      padding: var(--space-3);
    }

    .card-title {
      font-size: var(--text-base);
    }

    .card-summary {
      font-size: var(--text-sm);
    }
  }
</style>
